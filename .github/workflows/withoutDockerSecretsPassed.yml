# Name of the GitHub Actions workflow
name: Playwright API Tests - WITHOUT DOCKER

# Events that trigger this workflow
on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  # -------------------
  # BUILD JOB
  # -------------------
  build-job:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository code
      - name: Checkout repo
        uses: actions/checkout@v4

      # Setup Node.js and enable Yarn cache
      # This cache is shared across jobs in the same workflow
      - name: Setup Node.js (with Yarn cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      # Install dependencies
      # Uses yarn.lock for deterministic installs
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # Optional: build step (keep if needed)
      # - name: Build project
      #   run: yarn build

  # -------------------
  # TEST JOB
  # -------------------
  api-int-secretPassed:
    runs-on: ubuntu-latest

    # Run only after build-job succeeds
    needs: build-job

    # Targeting the correct environment on github actions is necessary
    environment: CI CD Env

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Setup Node.js and reuse Yarn cache
      - name: Setup Node.js (with Yarn cache)
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'yarn'

      # Install dependencies (fast due to cache)
      - name: Install dependencies
        run: yarn install --frozen-lockfile

      # Run Playwright API tests for api-int-secretPassed
      # Secrets/variables are injected via environment variables
      - name: Run Playwright tests (api-int-secretPassed)
        run: npx playwright test tests/api-int-secretPassed
        env:
          API_BASE_URL: ${{ vars.API_BASE_URL }}
          REPO_VARIABLE: ${{ vars.REPO_VARIABLE }}
